@page "/logs"
@using WebWasm.Models
@using WebWasm.Services
@using Microsoft.JSInterop
@inject ApiClient ApiClient
@inject LoadingService LoadingService
@inject ToastService ToastService
@inject IJSRuntime JSRuntime

<PageTitle>Logs</PageTitle>

<div class="content-card">
    <div class="card-header">
        <h3>System Logs</h3>
    </div>
    <div style="overflow-x: auto;">
        <table class="table logs-table">
            <thead>
                <tr>
                    <th style="width: 120px;">Time</th>
                    <th>Message</th>
                    <th style="width: 80px;">Tpl</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in _logItems)
                {
                    <tr class="@GetRowClass(item.Log.Level) @(HasException(item.Log) ? "expandable" : "")" 
                        @onclick="() => ToggleExpand(item)">
                        <td style="white-space: nowrap;">
                            <span class="badg-level">@item.Log.Level[0]</span>
                            @item.Log.TimeStamp.ToLocalTime().ToString("MM/dd HH:mm")
                        </td>
                        <td>
                            @item.Log.Message
@*                             @if (item.IsExpanded && HasException(item.Log))
                            {
                                <div class="exception-details" @onclick:stopPropagation>
                                    <pre>@item.Log.Exception</pre>
                                </div>
                            } *@
                        </td>
                        <td title="@item.Log.MessageTemplate" @onclick:stopPropagation>
                            <button class="btn-copy" @onclick="() => CopyToClipboard(item.Log.MessageTemplate)">ðŸ“‹</button>
                        </td>
                    </tr>
                    @if(item.IsExpanded && HasException(item.Log))
                    {
                        <tr>
                            <td colspan="3">
                                <div class="exception-details" @onclick:stopPropagation>
                                    <pre>@item.Log.Exception</pre>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    .logs-table {
        border-collapse: separate;
        border-spacing: 0 4px;
    }
    .logs-table tr {
        transition: all 0.2s;
    }

    .log-row-error td:nth-child(1) {
        border-left: 4px solid #dc3545;
    }

    .log-row-error td {
        background-color: rgba(220, 53, 69, 0.1);
    }

    .log-row-warning td:nth-child(1) {
        border-left: 4px solid #ffc107;
    }

    .log-row-warning td {
        background-color: rgba(255, 193, 7, 0.1);
    }

    .log-row-info td:nth-child(1) {
        border-left: 4px solid #0dcaf0;
    }

    .log-row-info td {
        background-color: white;
    }

    .expandable {
        cursor: pointer;
    }

    .expandable td {
            border-top: 1px solid black;
            border-bottom: 1px solid black !important;
    }

    .expandable:hover {
        background-color: rgba(0,0,0,0.02);
    }
    .exception-details {
        margin-top: 10px;
        padding: 10px;
        background: #1e1e1e;
        color: #d4d4d4;
        border-radius: 6px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
        overflow-x: auto;
        white-space: pre-wrap;
    }
    .exception-details pre {
        margin: 0;
    }
    .btn-copy {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.1em;
        opacity: 0.7;
        padding: 4px;
        transition: opacity 0.2s;
    }
    .btn-copy:hover {
        opacity: 1;
    }
    .badg-level {
        display: inline-block;
        width: 18px;
        height: 18px;
        line-height: 18px;
        text-align: center;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: bold;
        margin-right: 6px;
        background: rgba(0,0,0,0.1);
    }

    @@media (max-width: 480px) {
        .exception-details {
            font-size: 0.2em;
        }
    }
</style>

@code {
    private List<LogItem> _logItems = [];

    private class LogItem
    {
        public Log Log { get; set; } = default!;
        public bool IsExpanded { get; set; }
    }

    private bool HasException(Log log) => !string.IsNullOrEmpty(log.Exception);

    private string GetRowClass(string level) => level?.ToLower() switch
    {
        "error" or "fatal" => "log-row-error",
        "warning" => "log-row-warning",
        _ => "log-row-info"
    };

    private void ToggleExpand(LogItem item)
    {
        if (HasException(item.Log))
        {
            item.IsExpanded = !item.IsExpanded;
        }
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
            ToastService.ShowSuccess("Template copied");
        }
        catch
        {
            ToastService.ShowError("Failed to copy");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadingService.ExecuteWithLoading(async () =>
        {
            try
            {
                var logs = await ApiClient.Get<Log[]>("Counts/logs");
                _logItems = logs.Select(l => new LogItem { Log = l }).ToList();
                ToastService.ShowSuccess("Logs loaded successfully");
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Failed to load logs: {ex.Message}");
            }
        });
    }
}
