@using Microsoft.AspNetCore.Components.QuickGrid
@using WebWasm.Models
@using WebWasm.Services

<div class="data-grid-container">
	<div class="data-grid-search">
		<input type="text" 
			   placeholder="Search vehicles..." 
			   @bind="_searchText" 
			   @bind:event="oninput"
			   class="search-input" />
	</div>

	@if (HasItems)
	{
		<div class="data-grid-scroll">
			<QuickGrid Items="@FilteredVehicles" Pagination="@_pagination" class="data-grid">
				<PropertyColumn Property="@(v => v.Model)" Title="Model" Sortable="true" />
				<PropertyColumn Property="@(v => v.RegistrationNumber)" Title="Registration" Sortable="true" />
				<TemplateColumn Title="Driver" Sortable="false">
					<div class="driver-cell">
						@if (context.Driver?.UserInfo != null)
						{
							<div class="driver-thumbnail-container">
								<button class="driver-thumbnail" @onclick="() => ToggleDriverExpand(context.Id)">
									@if (!string.IsNullOrEmpty(context.Driver.Photo))
									{
										<img src="@context.Driver.Photo" alt="Driver" class="driver-photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
										<div class="default-avatar" style="display: none;">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
												<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
											</svg>
										</div>
									}
									else
									{
										<div class="default-avatar">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
												<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
											</svg>
										</div>
									}
								</button>
								@if (IsDriverExpanded(context.Id))
								{
									<div class="driver-info-expanded">
										<div class="driver-detail">
											<span class="driver-label">Name:</span>
											<span class="driver-value">@context.Driver.UserInfo.FirstName @context.Driver.UserInfo.LastName</span>
										</div>
										<div class="driver-detail">
											<span class="driver-label">Phone:</span>
											<span class="driver-value">@context.Driver.UserInfo.MobilePhone</span>
										</div>
									</div>
								}
							</div>
						}
						else
						{
							<span class="text-muted">No driver assigned</span>
						}
					</div>
				</TemplateColumn>
				<PropertyColumn Property="@(v => v.VehicleWeight)" Title="Weight (kg)" Sortable="true" />
				<PropertyColumn Property="@(v => v.LoadCapacity)" Title="Capacity (kg)" Sortable="true" />
				<TemplateColumn Title="Photo" Sortable="false">
					<div class="photo-cell">
						@if (!string.IsNullOrEmpty(context.Photo))
						{
							<button class="btn-view-photo" @onclick="() => TogglePhotoExpand(context.Id)">
								@(IsPhotoExpanded(context.Id) ? "‚ñº" : "‚ñ∂") View Photo
							</button>
							@if (IsPhotoExpanded(context.Id))
							{
								<div class="photo-expanded">
									<img src="@context.Photo" alt="@context.Model" class="vehicle-photo" />
								</div>
							}
						}
						else
						{
							<span class="text-muted">No photo</span>
						}
					</div>
				</TemplateColumn>
				<TemplateColumn Title="Actions" Sortable="false">
					<div class="vehicle-actions">
						<button class="btn-action btn-delete" 
								@onclick="() => OnDelete.InvokeAsync(context)">
							üóëÔ∏è Delete
						</button>
					</div>
				</TemplateColumn>
			</QuickGrid>
		</div>

		@if (FilteredVehicles.Count() > _pagination.ItemsPerPage)
		{
			<div class="data-grid-pagination">
				<CustomPaginator State="@_pagination" />
			</div>
		}
	}
	else
	{
		<div class="empty-state">
			<p>No vehicles registered yet</p>
		</div>
	}
</div>
